# vBulletin Forum Scraper - AWS Deployment
#
# This workflow deploys and runs the forum scraper on AWS EC2.
# Uses spot instances for cost efficiency on long-running tasks.
#
# Required secrets:
#   AWS_ACCESS_KEY_ID      - AWS access key with EC2/S3/SSM permissions
#   AWS_SECRET_ACCESS_KEY  - AWS secret key
#   AWS_REGION             - AWS region (e.g., us-east-1)
#   S3_BUCKET              - S3 bucket for storing results
#
# Optional secrets:
#   SLACK_WEBHOOK_URL      - For notifications (optional)

name: Forum Scraper

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy        # Deploy infrastructure and start scraper
          - start         # Start scraper on existing instance
          - stop          # Stop scraper gracefully
          - status        # Check scraper status
          - sync          # Sync results to S3
          - teardown      # Terminate instance and cleanup
      stage:
        description: 'Scraper stage to run'
        required: false
        type: choice
        default: 'all'
        options:
          - discover
          - threads
          - posts
          - images
          - all
      forum_id:
        description: 'Forum ID to scrape (required for threads/posts/images)'
        required: false
        type: string
      max_threads:
        description: 'Max threads to scrape (for testing)'
        required: false
        type: string
        default: ''
      instance_type:
        description: 'EC2 instance type'
        required: false
        type: choice
        default: 't3.small'
        options:
          - t3.micro
          - t3.small
          - t3.medium

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  STACK_NAME: e30-forum-scraper
  PROJECT_NAME: vlm3-scraper

jobs:
  deploy:
    if: github.event.inputs.action == 'deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation stack
        run: |
          aws cloudformation deploy \
            --template-file scraper/deploy/cloudformation.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --parameter-overrides \
              InstanceType=${{ github.event.inputs.instance_type }} \
              S3Bucket=${{ env.S3_BUCKET }} \
              ProjectName=${{ env.PROJECT_NAME }} \
            --capabilities CAPABILITY_IAM \
            --no-fail-on-empty-changeset

      - name: Get instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance ID: $INSTANCE_ID"

      - name: Wait for instance to be ready
        run: |
          aws ec2 wait instance-status-ok \
            --instance-ids ${{ steps.instance.outputs.instance_id }}

      - name: Setup scraper on instance
        run: |
          aws ssm send-command \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "cd /home/ec2-user",
              "git clone https://github.com/${{ github.repository }}.git scraper || (cd scraper && git pull)",
              "cd scraper",
              "python3 -m venv .venv",
              "source .venv/bin/activate",
              "pip install -r scraper/requirements.txt",
              "mkdir -p forum_archive/{raw,data,checkpoints,logs}"
            ]' \
            --output text

      - name: Output connection info
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Instance ID: ${{ steps.instance.outputs.instance_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Public IP: $PUBLIC_IP" >> $GITHUB_STEP_SUMMARY
          echo "- Connect via SSM: aws ssm start-session --target ${{ steps.instance.outputs.instance_id }}" >> $GITHUB_STEP_SUMMARY

  start:
    if: github.event.inputs.action == 'start'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Build scraper command
        id: cmd
        run: |
          STAGE="${{ github.event.inputs.stage }}"
          FORUM_ID="${{ github.event.inputs.forum_id }}"
          MAX_THREADS="${{ github.event.inputs.max_threads }}"

          CMD="cd /home/ec2-user/scraper && source .venv/bin/activate && "

          if [ "$STAGE" = "all" ]; then
            CMD="${CMD}python scraper/run_test_scrape.py --stage all"
            if [ -n "$FORUM_ID" ]; then
              CMD="${CMD} --forum-id $FORUM_ID"
            fi
          else
            case $STAGE in
              discover)
                CMD="${CMD}python scraper/01_discover_forums.py"
                ;;
              threads)
                CMD="${CMD}python scraper/02_scrape_threads.py --forum-id $FORUM_ID"
                ;;
              posts)
                CMD="${CMD}python scraper/03_scrape_posts.py --forum-id $FORUM_ID"
                ;;
              images)
                CMD="${CMD}python scraper/04_download_images.py --forum-id $FORUM_ID"
                ;;
            esac
          fi

          if [ -n "$MAX_THREADS" ]; then
            CMD="${CMD} --max-threads $MAX_THREADS"
          fi

          # Run in background with nohup
          CMD="nohup ${CMD} > forum_archive/logs/scraper.log 2>&1 &"

          echo "command=$CMD" >> $GITHUB_OUTPUT
          echo "Running: $CMD"

      - name: Start scraper
        run: |
          aws ssm send-command \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands='["${{ steps.cmd.outputs.command }}"]' \
            --output text

          echo "## Scraper Started" >> $GITHUB_STEP_SUMMARY
          echo "Stage: ${{ github.event.inputs.stage }}" >> $GITHUB_STEP_SUMMARY
          echo "Forum ID: ${{ github.event.inputs.forum_id }}" >> $GITHUB_STEP_SUMMARY

  status:
    if: github.event.inputs.action == 'status'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Check scraper status
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "echo \"=== Process Status ===\"",
              "pgrep -a python || echo \"No Python processes running\"",
              "echo \"\"",
              "echo \"=== Last 50 log lines ===\"",
              "tail -50 /home/ec2-user/scraper/forum_archive/logs/scraper.log 2>/dev/null || echo \"No log file\"",
              "echo \"\"",
              "echo \"=== Checkpoint Status ===\"",
              "ls -la /home/ec2-user/scraper/forum_archive/checkpoints/ 2>/dev/null || echo \"No checkpoints\"",
              "echo \"\"",
              "echo \"=== Data Files ===\"",
              "ls -lh /home/ec2-user/scraper/forum_archive/data/ 2>/dev/null || echo \"No data files\"",
              "echo \"\"",
              "echo \"=== Disk Usage ===\"",
              "df -h /home/ec2-user"
            ]' \
            --query "Command.CommandId" \
            --output text)

          sleep 5

          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ steps.instance.outputs.instance_id }} \
            --query "StandardOutputContent" \
            --output text

  sync:
    if: github.event.inputs.action == 'sync'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Sync results to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          aws ssm send-command \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              \"aws s3 sync /home/ec2-user/scraper/forum_archive s3://${{ env.S3_BUCKET }}/forum_archive --exclude '*.log'\",
              \"aws s3 cp /home/ec2-user/scraper/forum_archive/logs/scraper.log s3://${{ env.S3_BUCKET }}/logs/scraper_${TIMESTAMP}.log || true\"
            ]" \
            --output text

          echo "## Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "Results synced to s3://${{ env.S3_BUCKET }}/forum_archive" >> $GITHUB_STEP_SUMMARY

  stop:
    if: github.event.inputs.action == 'stop'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get instance ID
        id: instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Stop scraper gracefully
        run: |
          aws ssm send-command \
            --instance-ids ${{ steps.instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands='[
              "pkill -SIGINT -f \"python scraper/\" || true",
              "sleep 5",
              "echo \"Scraper stopped. Syncing to S3...\"",
              "aws s3 sync /home/ec2-user/scraper/forum_archive s3://${{ env.S3_BUCKET }}/forum_archive"
            ]' \
            --output text

  teardown:
    if: github.event.inputs.action == 'teardown'
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Sync final results before teardown
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='InstanceId'].OutputValue" \
            --output text 2>/dev/null || echo "")

          if [ -n "$INSTANCE_ID" ]; then
            aws ssm send-command \
              --instance-ids $INSTANCE_ID \
              --document-name "AWS-RunShellScript" \
              --parameters commands='[
                "aws s3 sync /home/ec2-user/scraper/forum_archive s3://${{ env.S3_BUCKET }}/forum_archive"
              ]' \
              --output text || true
            sleep 30
          fi

      - name: Delete CloudFormation stack
        run: |
          aws cloudformation delete-stack --stack-name ${{ env.STACK_NAME }}
          aws cloudformation wait stack-delete-complete --stack-name ${{ env.STACK_NAME }}

          echo "## Teardown Complete" >> $GITHUB_STEP_SUMMARY
          echo "Stack deleted. Results preserved in S3." >> $GITHUB_STEP_SUMMARY
