# Stage 3: Classification & Index Parsing - API Configuration
api:
  provider: anthropic
  # API key read from environment: ANTHROPIC_API_KEY
  max_retries: 3
  rate_limit_delay_seconds: 0.5  # Delay between API calls

  # Use different models for different tasks
  models:
    index_parsing: claude-sonnet-4-20250514    # More capable for structured extraction
    classification: claude-3-haiku-20240307    # Cost-efficient for simple classification

# Source type detection patterns
sources:
  service_manual_patterns:
    - "^[0-9]{2} - "
    - "^Getrag"
  electrical_manual_patterns:
    - "Electrical Troubleshooting"
  ecu_technical_patterns:
    - "Bosch Motronic"

# Content type classification settings
classification:
  # Valid content types by source type
  content_types:
    service_manual:
      - index
      - procedure
      - specification
      - diagram
      - troubleshooting
      - text
    electrical_manual:
      - index
      - wiring
      - pinout
      - fuse_chart
      - flowchart
      - text
    ecu_technical:
      - diagram
      - specification
      - flowchart
      - oscilloscope
      - text

  # Batch processing settings
  batch_size: 10  # Number of images to process before logging progress

  # Cost tracking
  track_tokens: true  # Log token usage for cost monitoring

sections:
  include_patterns: ["^[0-9]{2} - .*"]
  exclude_patterns: []

unit_canon:
  torque: "Nm"
  pressure: "bar"
  length: "mm"
  volume: "L"
  temp: "°C"

regex_fixes:
  # Fix common OCR errors
  - { pattern: "\\bIitre(s)?\\b", replace: "litre" }  # OCR misread of 'litre'
  - { pattern: "\\bNrn\\b", replace: "Nm" }           # OCR misread of 'Nm'
  - { pattern: "\\bmrn\\b", replace: "mm" }           # OCR misread of 'mm'
  # Note: Removed "MM" -> "Nm" as this incorrectly converted millimeters to Newton-meters

type_keywords:
  procedure: ["remove and install","adjust","overhaul","installation","removal","bleed"]
  troubleshooting: ["symptom","troubleshoot","checks","fault","diagnosis"]
  wiring: ["wiring diagram","schematic","connector","pin","legend"]
  spec_table: ["torque","capacity","pressure","clearance","thickness","diameter"]
  explanation: ["description","operation","general information"]

task_rules:
  spec: { value_only: true, allow_alt_units: true }
  procedure: { numbered: true, max_steps: 25 }
  troubleshooting: { numbered: true, max_checks: 15 }
  explanation: { max_sentences: 6 }

validation:
  spec_output_regex: "^[0-9~≈><=.,/\\-\\s]+[A-Za-z°µ]*$"
  step_line_regex: "^\\s*\\d[\\)\\.]\\s"
  max_output_tokens: 200

# HuggingFace finetuning configuration
huggingface:
  model_name: "meta-llama/Llama-3.2-3B-Instruct"
  task_prefix_format: "[{TASK}] {instruction}"
  max_seq_length: 512

# QLoRA configuration for efficient finetuning
qlora:
  r: 16                    # LoRA rank (attention dimension)
  lora_alpha: 32          # LoRA scaling factor (typically 2x rank)
  lora_dropout: 0.05      # Dropout for LoRA layers
  target_modules:         # Which modules to apply LoRA
    - "q_proj"
    - "v_proj"
    - "k_proj"
    - "o_proj"
  bias: "none"            # Bias handling: none, all, lora_only
  task_type: "CAUSAL_LM"  # Task type for PEFT

# Training hyperparameters (optimized for Llama-3.2-3B)
training:
  num_epochs: 3
  per_device_train_batch_size: 8  # Larger batch for smaller model
  gradient_accumulation_steps: 2  # Effective batch size = 8 * 2 = 16
  learning_rate: 2e-4
  warmup_ratio: 0.1               # 10% of steps for warmup
  weight_decay: 0.01
  optim: "paged_adamw_8bit"       # 8-bit optimizer for memory efficiency
  logging_steps: 10
  save_strategy: "epoch"          # Save checkpoint each epoch
  eval_strategy: "epoch"          # Evaluate each epoch (renamed from evaluation_strategy)
  save_total_limit: 2             # Keep only 2 best checkpoints
  load_best_model_at_end: true
  metric_for_best_model: "loss"
  gradient_checkpointing: true    # Memory optimization
  fp16: true                      # Mixed precision training (use bf16 for A100)

# Class weights for loss computation (inverse frequency)
# Used during training to balance task importance
class_weights:
  spec: 0.5             # Downweight majority class
  explanation: 1.0      # Baseline weight
  procedure: 3.0        # Upweight minority class
  wiring: 5.0           # Upweight minority class
  troubleshooting: 10.0 # Upweight extremely rare class

# Stage 4: Q&A Generation settings
generation:
  # API settings
  model: claude-sonnet-4-20250514
  max_retries: 3
  retry_delay_seconds: 2
  rate_limit_delay_seconds: 1.0

  # Token limits
  max_output_tokens: 4096  # Enough for 12 Q&A pairs

  # Cost controls
  max_cost_per_page_usd: 0.10  # Abort if estimated cost exceeds
  daily_budget_usd: 50.00      # Optional daily limit (null to disable)
  warn_at_budget_percent: 80   # Warn when this % of daily budget used

  # Estimation (for logging, not enforced)
  estimated_input_tokens_per_page: 2000
  estimated_output_tokens_per_page: 800

  # Image preprocessing
  image:
    max_size_mb: 5.0       # Compress if larger
    max_dimension: 4096    # Resize if larger
    jpeg_quality: 85       # Initial quality (reduces on retry)
    min_jpeg_quality: 30   # Minimum quality before failing

  # Validation
  validation:
    strict_mode: false     # If true, reject any Q&A with warnings
    min_question_length: 10
    min_answer_length: 5

  # Questions per page by content type
  questions_per_page:
    # Service manual
    index: 6
    procedure: 12
    specification: 10
    diagram: 8
    troubleshooting: 10
    text: 6
    # Electrical manual
    wiring: 10
    pinout: 8
    fuse_chart: 8
    flowchart: 8
    # ECU technical
    signal: 8
    oscilloscope: 8

  # Skip patterns
  skip_patterns:
    - "*-blank-*"
    - "*-cover-*"
    - "*-title-*"

  # Skip content types (no useful Q&A)
  # Note: Index pages DO generate Q&A (navigation questions about repair codes,
  # procedure locations, etc.) per the architecture spec. Only skip truly
  # empty page types like blank pages or covers.
  skip_content_types:
    - "blank"
    - "cover"
    - "title"

  # Batch processing
  batch_size: 10
  checkpoint_interval: 50

# Stage 5: Q&A Quality Filters
filters:
  # Answer constraints
  min_answer_length: 10          # Minimum characters
  max_answer_length: 500         # Maximum characters (prevent rambling)

  # Question constraints
  min_question_length: 15        # Minimum characters
  require_question_mark: true    # Must end with "?"

  # Question diversity (per page)
  max_question_similarity: 0.80  # Reject if >80% word overlap with another Q on same page
  min_question_types_per_page: 2 # Warn if fewer than 2 different question_types

  # Generic answer patterns (reject if answer contains these)
  generic_answer_patterns:
    - "cannot determine"
    - "not visible"
    - "unclear from"
    - "I don't see"
    - "I cannot see"
    - "I can't determine"
    - "the image doesn't show"
    - "not specified"
    - "please refer to"
    - "typically"
    - "usually"
    - "generally"

  # Self-referential patterns (reject if question contains these)
  self_referential_patterns:
    - "on this page"
    - "in this image"
    - "as shown here"
    - "the manual states"
    - "according to the page"
    - "depicted in"

  # Valid question types
  valid_question_types:
    - factual
    - procedural
    - visual
    - inspection
    - tool
    - safety
    - navigation
    - wiring
    - connector
    - component
    - diagnostic
    - troubleshooting
    - signal
    - parameter
    - operation

# Stage 5: Deduplication settings
deduplication:
  # Exact match detection
  enable_exact_match: true

  # Semantic similarity (requires sentence-transformers)
  enable_semantic: true
  embedding_model: "all-MiniLM-L6-v2"
  similarity_threshold: 0.90     # Questions with >0.90 cosine similarity are duplicates

  # Cross-page duplicate handling
  cross_page_enabled: true
  prefer_strategy: "longer_answer"  # Options: longer_answer, higher_confidence, first_seen

  # Batch processing for embeddings
  embedding_batch_size: 64

# Stage 6: Output settings (Emit)
output:
  # Train/validation split
  train_split: 0.90              # 90% train, 10% val
  random_seed: 42                # For reproducible splits

  # Image handling
  image_copy_mode: symlink       # Options: symlink, copy, relative
  image_output_dir: images       # Subdirectory within data/

  # Image filename normalization
  normalize_image_names: true    # Convert spaces/special chars to underscores

  # Stratification
  stratify_by: section_id        # Options: section_id, source_type, none

  # Minimum samples per stratum for stratification
  min_stratum_size: 10           # Fall back to random if stratum too small

# Stage 6: Validation settings
vlm_validation:
  # Schema checks
  require_image_field: true      # Every record must have "image" key
  require_conversations: true    # Every record must have "conversations" key
  require_metadata: true         # Every record must have "metadata" key

  # Image validation
  check_image_exists: true       # Verify image files exist
  check_image_readable: true     # Verify images can be opened by PIL
  min_image_width: 100           # Warn if image width < this
  min_image_height: 100          # Warn if image height < this

  # Content validation
  min_question_length: 10        # Warn if question < this
  min_answer_length: 5           # Warn if answer < this
  max_answer_length: 1000        # Warn if answer > this

  # Distribution checks
  min_qa_per_section: 5          # Warn if section has fewer Q&A
  max_qa_per_section: 2000       # Warn if section has more Q&A (possible duplication)

  # Sample output
  num_samples_per_split: 5       # Number of samples to include in report

# Stage 6: HuggingFace upload settings
upload:
  repo_id: null                  # e.g., "drumwell/vlm3-vlm" (required for upload)
  private: false                 # Whether dataset is private
  commit_message: "Update VLM training dataset"

  # Dataset card metadata
  dataset_card:
    language: en
    license: cc-by-nc-4.0
    task_categories:
      - visual-question-answering
      - image-to-text
    tags:
      - automotive
      - bmw
      - service-manual
      - vlm
